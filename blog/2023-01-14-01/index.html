<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta name="description"><title>mattn | Scraping Together a Blacksburg Transit Route Map</title><style>html{visibility:hidden;opacity:0}</style><link href="https://www.mattnewcomer.org/style.css" rel="stylesheet"></head><body><header class="space"><a href="https://www.mattnewcomer.org">← Home</a></header><main><h1>Scraping Together a Blacksburg Transit Route Map</h1><p class="secondary">14 January 2023</p><div class="space"></div><p>The Blacksburg Transit bus system is pretty cool, but it doesn’t produce a map that has all routes on it simultaneously. Why not try to scrape one together?</p><p>Step one was to determine how data is displayed on the website. The <a href="https://ridebt.org" rel="noreferrer">BT Website</a> displays a live map of all routes and buses in operation.</p><p>Opening up the network inspector and reloading the page yielded this stream of requests:</p><figure><img alt="A table displaying a series of network requests to ridebt.org for data" src="bus_network_traffic.png" width="800"><figcaption>Roughly ten seconds worth of bus update data</figcaption></figure><p>Opening up the first request yielded a JSON object, with an entry for each bus currently in service with route data. Expanding the <code>states</code> field showed information about the bus’ location, speed, heading, and if it’s at a stop.</p><figure><img alt="A table displaying a series of fields with information about the bus in service" src="TOM_route_data.png" width="400"></figure><figure><img alt="A table displaying a series of fields with information about the physical state of the bus" src="TOM_route_states.png" width="400"></figure><p>Cool, so this provides the locations of the buses, but the map also renders the routes on the map. How does it do that? I clicked on a new bus and spotted a different URL being passed back to the website.</p><figure><img alt="A table displaying a series of fields with information about the route selected" src="MSN_route_points.png" width="800"></figure><p>It seems that selecting the route (which loads all of the lines on the map) makes a call to <code>getPatternPoints</code>, which accepts a route name. The response is a list of every point that makes up the route, and if it is a stop or just a waypoint.</p><figure><img alt="A table displaying a series of fields with information about the bus in service" src="MSN_route_data.png" width="400"></figure><p>I decided to try and chain together the list of active routes, then for each route, query the set of points then plot them all on the same map. I started by querying the <code>patternName</code> of each route:</p><pre class="language-python" data-lang="python" data-linenos="" style="background:#282828;color:#fdf4c1aa"><code class="language-python" data-lang="python"><table><tbody><tr><td>1</td><td><span style="color:#fa5c4b">import </span><span>requests, json
</span></td></tr><tr><td>2</td><td><span>
</span></td></tr><tr><td>3</td><td><span>buses_response </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">requests.get(</span><span style="color:#b8bb26">"https://ridebt.org/index.php?option=com_ajax&amp;module=bt_map&amp;format=json&amp;method=getBuses"</span><span style="color:#fdf4c1">)
</span></td></tr><tr><td>4</td><td><span style="color:#fa5c4b">assert</span><span>(buses_response.status_code </span><span style="color:#fe8019">== </span><span>requests.codes.ok)
</span></td></tr><tr><td>5</td><td><span>
</span></td></tr><tr><td>6</td><td><span>routes </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">json.loads(buses_response.text)
</span></td></tr><tr><td>7</td><td><span>pattern_names </span><span style="color:#fe8019">= </span><span>[]
</span></td></tr><tr><td>8</td><td><span style="color:#fa5c4b">for </span><span>route </span><span style="color:#fa5c4b">in </span><span>routes[</span><span style="color:#b8bb26">'data'</span><span>]:
</span></td></tr><tr><td>9</td><td><span>    </span><span style="color:#fabd2f">print</span><span style="color:#fdf4c1">(route[</span><span style="color:#b8bb26">'patternName'</span><span style="color:#fdf4c1">])
</span></td></tr></tbody></table></code></pre><pre style="background:#282828;color:#fdf4c1aa"><code><span>Toms Creek - Progress
</span><span>HWD-HDG
</span><span>Two Town Trolley - Inbound Hospital
</span><span>Main Street South - Ellett
</span></code></pre><p>Given the pattern, pass it to <code>getPatternPoints</code>:</p><pre class="language-python" data-lang="python" data-linenos="" style="background:#282828;color:#fdf4c1aa"><code class="language-python" data-lang="python"><table><tbody><tr><td>6</td><td><span>routes </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">json.loads(buses_response.text)
</span></td></tr><tr><td>7</td><td><span>pattern_names </span><span style="color:#fe8019">= </span><span>[]
</span></td></tr><tr><td>8</td><td><span style="color:#fa5c4b">for </span><span>route </span><span style="color:#fa5c4b">in </span><span>routes[</span><span style="color:#b8bb26">'data'</span><span>]:
</span></td></tr><tr><td>9</td><td><span>    </span><span style="color:#fdf4c1">pattern_names.append(route[</span><span style="color:#b8bb26">'patternName'</span><span style="color:#fdf4c1">])
</span></td></tr><tr><td>10</td><td><span>
</span></td></tr><tr><td>11</td><td><span style="color:#fa5c4b">for </span><span>pattern_name </span><span style="color:#fa5c4b">in </span><span>pattern_names:
</span></td></tr><tr><td>12</td><td><span>    points_response </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">requests.get(</span><span style="color:#b8bb26">"https://ridebt.org/index.php?option=com_ajax&amp;module=bt_map&amp;format=json&amp;method=getPatternPoints&amp;patternName="</span><span style="color:#fe8019">+</span><span style="color:#fdf4c1">pattern_name)
</span></td></tr><tr><td>13</td><td><span>    </span><span style="color:#fa5c4b">assert</span><span>(points_response.status_code </span><span style="color:#fe8019">== </span><span>requests.codes.ok)
</span></td></tr><tr><td>14</td><td><span>
</span></td></tr><tr><td>15</td><td><span>    pattern_waypoints </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">json.loads(points_response.text)
</span></td></tr><tr><td>16</td><td><span>    </span><span style="color:#fa5c4b">for </span><span>waypoint </span><span style="color:#fa5c4b">in </span><span>pattern_waypoints[</span><span style="color:#b8bb26">'data'</span><span>]:
</span></td></tr><tr><td>17</td><td><span>        </span><span style="color:#fabd2f">print</span><span style="color:#fdf4c1">(waypoint)
</span></td></tr></tbody></table></code></pre><pre style="background:#282828;color:#fdf4c1aa"><code><span>966 rows...
</span><span>{'routeShortName': '161', 'patternPointName': 'Alumni Mall Wbnd', 'isBusStop': 'Y', 'isTimePoint': 'N', 'stopCode': '1112', 'latitude': '37.23134', 'longitude': '-80.4166'}
</span><span>{'routeShortName': '162', 'patternPointName': 'Way Point', 'isBusStop': 'N', 'isTimePoint': 'N', 'stopCode': '', 'latitude': '37.2312', 'longitude': '-80.4168'}
</span><span>{'routeShortName': '163', 'patternPointName': 'Way Point', 'isBusStop': 'N', 'isTimePoint': 'N', 'stopCode': '', 'latitude': '37.23094', 'longitude': '-80.4172'}
</span><span>{'routeShortName': '164', 'patternPointName': 'Way Point', 'isBusStop': 'N', 'isTimePoint': 'N', 'stopCode': '', 'latitude': '37.23056', 'longitude': '-80.4178'}
</span><span>{'routeShortName': '165', 'patternPointName': 'Squires Wbnd', 'isBusStop': 'Y', 'isTimePoint': 'Y', 'stopCode': '1113', 'latitude': '37.22977', 'longitude': '-80.4191'}
</span></code></pre><p>So that’s all of the data… in an unusable format; let me organize it using dictionaries. These dictionaries can be used later to attach route metadata.</p><pre class="language-python" data-lang="python" data-linenos="" style="background:#282828;color:#fdf4c1aa"><code class="language-python" data-lang="python"><table><tbody><tr><td>1</td><td><span style="color:#fa5c4b">import </span><span>requests, json
</span></td></tr><tr><td>2</td><td><span style="color:#fa5c4b">import </span><span>matplotlib.pyplot </span><span style="color:#fa5c4b">as </span><span>plt
</span></td></tr><tr><td>3</td><td><span>
</span></td></tr><tr><td>4</td><td><span>buses_response </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">requests.get(</span><span style="color:#b8bb26">"https://ridebt.org/index.php?option=com_ajax&amp;module=bt_map&amp;format=json&amp;method=getBuses"</span><span style="color:#fdf4c1">)
</span></td></tr><tr><td>5</td><td><span style="color:#fa5c4b">assert</span><span>(buses_response.status_code </span><span style="color:#fe8019">== </span><span>requests.codes.ok)
</span></td></tr><tr><td>6</td><td><span>
</span></td></tr><tr><td>7</td><td><span>buses </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">json.loads(buses_response.text)
</span></td></tr><tr><td>8</td><td><span>route_data </span><span style="color:#fe8019">= </span><span>{}
</span></td></tr><tr><td>9</td><td><span style="color:#fa5c4b">for </span><span>bus </span><span style="color:#fa5c4b">in </span><span>buses[</span><span style="color:#b8bb26">'data'</span><span>]:
</span></td></tr><tr><td>10</td><td><span>    route_data[bus[</span><span style="color:#b8bb26">'patternName'</span><span>]] </span><span style="color:#fe8019">= </span><span>{}
</span></td></tr><tr><td>11</td><td><span>
</span></td></tr><tr><td>12</td><td><span style="color:#fa5c4b">for </span><span>pattern_name </span><span style="color:#fa5c4b">in </span><span>route_data:
</span></td></tr><tr><td>13</td><td><span>    points_response </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">requests.get(</span><span style="color:#b8bb26">"https://ridebt.org/index.php?option=com_ajax&amp;module=bt_map&amp;format=json&amp;method=getPatternPoints&amp;patternName=" </span><span style="color:#fe8019">+ </span><span style="color:#fdf4c1">pattern_name)
</span></td></tr><tr><td>14</td><td><span>    </span><span style="color:#fa5c4b">assert</span><span>(points_response.status_code </span><span style="color:#fe8019">== </span><span>requests.codes.ok)
</span></td></tr><tr><td>15</td><td><span>
</span></td></tr><tr><td>16</td><td><span>    pattern_waypoints </span><span style="color:#fe8019">= </span><span style="color:#fdf4c1">json.loads(points_response.text)
</span></td></tr><tr><td>17</td><td><span>    route_data[pattern_name][</span><span style="color:#b8bb26">'waypoints'</span><span>] </span><span style="color:#fe8019">= </span><span>[]
</span></td></tr><tr><td>18</td><td><span>    </span><span style="color:#fa5c4b">for </span><span>waypoint </span><span style="color:#fa5c4b">in </span><span>pattern_waypoints[</span><span style="color:#b8bb26">'data'</span><span>]:
</span></td></tr><tr><td>19</td><td><span>        route_data[pattern_name][</span><span style="color:#b8bb26">'waypoints'</span><span>]</span><span style="color:#fdf4c1">.append((</span><span style="color:#fabd2f">float</span><span style="color:#fdf4c1">(waypoint[</span><span style="color:#b8bb26">'longitude'</span><span style="color:#fdf4c1">]),</span><span style="color:#fabd2f">float</span><span style="color:#fdf4c1">(waypoint[</span><span style="color:#b8bb26">'latitude'</span><span style="color:#fdf4c1">])))
</span></td></tr><tr><td>20</td><td><span>
</span></td></tr><tr><td>21</td><td><span style="color:#fa5c4b">for </span><span>pattern_name </span><span style="color:#fa5c4b">in </span><span>route_data:
</span></td></tr><tr><td>22</td><td><span>    </span><span style="font-style:italic;color:#928374"># zip(*&lt;iterable&gt;) acts as an unzip; transforms tuples into lists
</span></td></tr><tr><td>23</td><td><span>    </span><span style="font-style:italic;color:#928374"># https://stackoverflow.com/questions/19339/transpose-unzip-function-inverse-of-zip
</span></td></tr><tr><td>24</td><td><span>    </span><span style="font-style:italic;color:#928374"># The outer asterisk unpacks the zip object so that two lists are passed
</span></td></tr><tr><td>25</td><td><span>    </span><span style="color:#fdf4c1">plt.plot(</span><span style="color:#fe8019">*</span><span style="color:#fabd2f">zip</span><span style="color:#fdf4c1">(</span><span style="color:#fe8019">*</span><span style="color:#fdf4c1">route_data[pattern_name][</span><span style="color:#b8bb26">'waypoints'</span><span style="color:#fdf4c1">]))
</span></td></tr><tr><td>26</td><td><span style="color:#fdf4c1">plt.show()
</span></td></tr></tbody></table></code></pre><p><code>route_data</code> has a pattern-named key that contains a list of <code>(longitude, latitude)</code> tuples.</p><pre style="background:#282828;color:#fdf4c1aa"><code><span>{
</span><span>    'Toms Creek - Progress': 
</span><span>        {'waypoints': [(-80.4208, 37.22967), (-80.4209, 37.22971), ...]},
</span><span>    'HWD-HDG': 
</span><span>        {'waypoints': [(-80.4191, 37.22977), (-80.4203, (37.22906), ...]},
</span><span>    'Two Town Trolley - Inbound Hospital': 
</span><span>        {'waypoints': [(-80.4186, 37.2298), (-80.4172, 37.23071), ...]},
</span><span>    'Main Street South - Ellett': 
</span><span>        {'waypoints': [(-80.4191, 37.22977), (-80.4193, 37.22964), ...]}
</span><span>}
</span></code></pre><p>When executed, the code outputs the following image:</p><figure><img alt="A map showing the TTT, TOM, HDG, and MSN routes of the Blacksburg Transit network" src="all_routes.png" width="400"></figure><p>As I write this, it’s a Saturday so fewer routes are in operation. When the spring semester begins I’ll run it again to see the network’s coverage of town. I think a little bit of network scraping went a long way.</p><p>Areas for improvement:</p><ul><li>I think I’d like to add a way to color the routes the same as the website, but I couldn’t find a programmatic way beyond hard coding. Same can be said for a label.</li><li>The aspect ratio of the map isn’t set.</li><li>If a bus switches routes (e.g. HDG/HWD), this map is only able of displaying the route currently being driven. See <a href="https://www.mattnewcomer.org/blog/2023-01-14-01/./all_routes_alt.png">this</a> image for an example. If the program was left running, there might be a way to layer every route driven.</li></ul></main><div class="dark-mode-buttons"><button class="dark-mode-button dark-mode-hide" id="dark-mode-disable-button"><img alt="Dark mode" aria-label="dark mode toggle" title="Dark mode" height="24" src="https://www.mattnewcomer.org/dark_mode.svg" width="24"></button><button class="dark-mode-button dark-mode-show" id="dark-mode-enable-button"><img alt="Light mode" aria-label="light mode toggle" title="Light mode" height="24" src="https://www.mattnewcomer.org/light_mode.svg" width="24"></button></div><script>const cls=document.body.classList;const getSessionTheme=sessionStorage.getItem("theme");if(getSessionTheme==="dark"){cls.toggle("dark-mode",true)}else if(getSessionTheme==="light"){cls.toggle("dark-mode",false)}else if(window.matchMedia("(prefers-color-scheme: dark)").matches){cls.toggle("dark-mode",true)};document.getElementById("dark-mode-disable-button").addEventListener("click",function(a){cls.toggle("dark-mode",true);sessionStorage.setItem("theme","dark")});document.getElementById("dark-mode-enable-button").addEventListener("click",function(a){cls.toggle("dark-mode",false);sessionStorage.setItem("theme","light")})</script><noscript><style>.dark-mode-buttons{display:none}</style></noscript></body></html>